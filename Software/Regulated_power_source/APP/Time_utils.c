// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 2020-11-10
// 18:58:24
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#include   "App.h"

/*-----------------------------------------------------------------------------------------------------


  \param ms

  \return uint32_t
-----------------------------------------------------------------------------------------------------*/
uint32_t time_delay(uint32_t ms)
{
  return tx_thread_sleep(MS_TO_TICKS(ms));
}


/*-----------------------------------------------------------------------------------------------------


  \param ms

  \return uint32_t
-----------------------------------------------------------------------------------------------------*/
uint32_t Wait_ms(uint32_t ms)
{
  return time_delay(ms);
}


/*-----------------------------------------------------------------------------------------------------


  \param p_time
-----------------------------------------------------------------------------------------------------*/
void Get_time(TIME_STRUCT *p_time)
{
  uint32_t cval;
  uint32_t lval =(PLLDIV2_CLK * (TIME_TICK_PERIOD / 1000000ul));
  uint64_t tmp;

  do
  {
    p_time->sec = system_sec_counter;
    cval = PIT_get_curr_val(TIME_PIT_TIMER);
    tmp = ((uint64_t)(lval - cval) * 1000000ull)/lval;
    p_time->usec =  (uint32_t)tmp ;
  }
  while (p_time->sec != system_sec_counter);

}

/*-----------------------------------------------------------------------------------------------------


  \param p_time

  \return uint32_t
-----------------------------------------------------------------------------------------------------*/
uint32_t Time_elapsed_sec(TIME_STRUCT *p_time)
{
  uint32_t secs;
  TIME_STRUCT now;
  Get_time(&now);
  secs = now.sec - p_time->sec;
  return secs;
}

